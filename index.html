<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Optima Bank Rewards - Redeem Your Points for Exclusive Vouchers</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/drift-zoom/drift-basic.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- Firebase App (core SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

  <!-- Firebase Authentication -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
  /* change .toast to .custom-toast */
  .custom-toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 9999;
    opacity: 0.95;
    animation: fadeInOut 3s forwards;
  }
  .custom-toast.success {
    background-color: #28a745; /* green */
  }
  .custom-toast.error {
    background-color: #dc3545; /* red */
  }
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(20px); }
    10%, 90% { opacity: 0.95; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(20px); }
  }
  .product-item.affordable {
    border: 2px solid #28a745 !important;
    background-color: #f8fff9 !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.15);
    border-radius: 10px;
  }

  .product-item.unaffordable {
    border: 2px solid #dc3545 !important;
    background-color: #fff8f8 !important;
    opacity: 0.8;
    border-radius: 10px;
  }

  .points-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: bold;
    z-index: 10;
    text-transform: uppercase;
  }

  .points-indicator.sufficient {
    background-color: #28a745;
    color: white;
  }

  .points-indicator.insufficient {
    background-color: #dc3545;
    color: white;
  }

  .btn-custom.affordable {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
    color: white !important;
  }

  .btn-custom.affordable:hover {
    background-color: #218838 !important;
    border-color: #1e7e34 !important;
  }

  .btn-custom.unaffordable {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
    cursor: not-allowed;
    opacity: 0.7;
  }

  .btn-custom.unaffordable:hover {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
  }

  .insufficient-points-text {
    color: #dc3545;
    font-size: 0.8rem;
    font-weight: bold;
    margin-top: 5px;
  }
  </style>

</head>

<body class="index-page">

  <!-- Confirmation Modal -->
<div class="modal fade" id="redeemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 12px;">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Redemption</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Your Points Balance:</strong> <span id="userPoints">0</span> pts</p>
        <p><strong>Voucher:</strong> <span id="voucherTitle"></span></p>
        <p><strong>Required Points:</strong> <span id="voucherPoints"></span> pts</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmRedeemBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

  <header id="header" class="header sticky-top">

    <!-- Main Header -->
    <div class="main-header">
      <div class="container-fluid container-xl">
        <div class="d-flex py-3 align-items-center justify-content-between">

          <!-- Logo -->
          <a href="index.html" class="logo d-flex align-items-center">
            <!-- Uncomment the line below if you also wish to use an image logo -->
            <!-- <img src="assets/img/logo.webp" alt=""> -->
            <h1 class="sitename">Optima Bank Rewards</h1>
          </a>

          <!-- Actions -->
          <div class="header-actions d-flex align-items-center justify-content-end">

            <!-- Cart -->
            <a href="cart.html" class="header-action-btn">
              <i class="bi bi-cart3"></i>
              <span class="badge">0</span>
            </a>

            <!-- Account -->
            <div class="dropdown account-dropdown">
              <button class="header-action-btn" data-bs-toggle="dropdown" id="accountBtn">
                <i class="bi bi-person"></i>
              </button>
              <div class="dropdown-menu">
                <div class="dropdown-header">
                  <h6>Welcome to <span class="sitename">Optima Bank</span></h6>
                  <p class="mb-0">Redeem Loyalty Rewards &amp; Manage Account</p>
                </div>
                <div class="dropdown-body">
                  <a class="dropdown-item d-flex align-items-center" href="account.html#settings">
                    <i class="bi bi-person-circle me-2"></i>
                    <span>My Profile</span>
                  </a>
                  <a class="dropdown-item d-flex align-items-center" href="account.html#orders">
                    <i class="bi bi-bag-check me-2"></i>
                    <span>My Redeem History</span>
                  </a>
                  <a class="dropdown-item d-flex align-items-center" href="account.html#points">
                    <i class="bi bi-coin me-2"></i>
                    <span>My Points Balance</span>
                  </a>
                </div>
                <div class="dropdown-footer" id="authButtons">
                  <a href="login.html" class="btn btn-primary w-100 mb-2">Sign In</a>
                  <a href="register.html" class="btn btn-outline-primary w-100">Register</a>
                </div>
              </div>
            </div>

            <!-- Mobile Navigation Toggle -->
            <i class="mobile-nav-toggle d-xl-none bi bi-list me-0"></i>

          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="header-nav">
      <div class="container-fluid container-xl position-relative">
        <nav id="navmenu" class="navmenu" style="display: flex; align-items: center; justify-content: space-between;">
          <ul>
            <li><a href="index.html" class="active">Home</a></li>
            <li><a href="category.html">Vouchers</a></li>
            <li><a href="cart.html">Cart</a></li>
            <li><a href="account.html">Account</a></li>              
          </ul>
          <div class="header-nav-points" style="display: none;">
            <h4 class="current-points" style="font-size: 14px; font-weight: 600; color: white; margin: 15px 0;">Current Points: <span id="currentPoints">0</span></h4>
          </div>
        </nav>
      </div>
    </div>

  </header>

  <main class="main">

    <!-- Hero Section -->
    <section id="hero" class="hero section">

      <div class="hero-container">
        <div class="hero-content">
          <div class="content-wrapper" data-aos="fade-up" data-aos-delay="100">
            <h1 class="hero-title">Unlock Savings with Exclusive Vouchers</h1>
            <p class="hero-description">Discover and redeem amazing deals on your favorite brands, all in one place. Your next great saving is just a click away!</p>
            <div class="hero-actions" data-aos="fade-up" data-aos-delay="200">
              <a href="#best-sellers" class="btn-primary">Browse Vouchers</a>
            </div>
            <div class="features-list" data-aos="fade-up" data-aos-delay="300">
              <div class="feature-item">
                <i class="bi bi-award"></i>
                <span>Thanks for Choosing Us</span>
              </div>
              <div class="feature-item">
                <i class="bi bi-tags"></i>
                <span>Rewards for Loyalty Members</span>
              </div>
            </div>
          </div>
        </div>

        <div class="hero-visuals">
          <div class="product-showcase" data-aos="fade-left" data-aos-delay="200">
            <div class="product-card featured">
              <img src="assets/img/panda.png" alt="Featured Image of Optima Bank" class="img-fluid">              
            </div>

            <div class="product-grid">
              <div class="product-mini" data-aos="zoom-in" data-aos-delay="400">
                <img src="assets/img/voucher/KFC_mini.jpg" alt="KFC" class="img-fluid">
                <span class="mini-price">20% Off</span>
              </div>
              <div class="product-mini" data-aos="zoom-in" data-aos-delay="500">
                <img src="assets/img/voucher/lazada_mini.png" alt="Lazada" class="img-fluid">
                <span class="mini-price">RM20 Off</span>
              </div>
            </div>
          </div>

          <div class="floating-elements">
            <div class="floating-icon cart" data-aos="fade-up" data-aos-delay="600">
              <i class="bi bi-cart3"></i>
            </div>
            <div class="floating-icon wishlist" data-aos="fade-up" data-aos-delay="700">
              <i class="bi bi-heart"></i>
            </div>
            <div class="floating-icon search" data-aos="fade-up" data-aos-delay="800">
              <i class="bi bi-search"></i>
            </div>
          </div>
        </div>
      </div>

    </section><!-- /Hero Section -->

    <!-- Best Sellers Section -->
    <section id="best-sellers" class="best-sellers section">

      <!-- Section Title -->
      <div class="container section-title" data-aos="fade-up">
        <h2>Latest Vouchers</h2>
      </div><!-- End Section Title -->

      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row g-5" id="voucher-list"></div>
      </div>
    </section><!-- /Best Sellers Section -->

    <!-- Promo Cards Section -->
    <section id="promo-cards" class="promo-cards section">
      <div class="container" data-aos="fade-up" data-aos-delay="100">

      <!-- Section Title -->
      <div class="container section-title" data-aos="fade-up" style="padding-bottom: 20px; padding-top: 40px;">
        <h2>Browse by Category</h2>
      </div><!-- End Section Title -->


        <div class="row gy-4">

          <div class="col-lg-6">
            <div class="category-featured" data-aos="fade-right" data-aos-delay="200">
              <div class="category-image">
                <img src="assets/img/category/food_beverage.jpg" alt="Category 1" class="img-fluid">
              </div>
              <div class="category-content">
                <h2>Food & Beverage</h2>
                <p>Discover vouchers under Food & Beverage category to satisfy your cravings and enjoy delightful dining experiences.</p>
                <a href="category.html?category=Food" class="btn-shop">Explore Vouchers<i class="bi bi-arrow-right"></i></a>
              </div>
            </div>
          </div>

          <div class="col-lg-6">

            <div class="row gy-4">

              <div class="col-xl-6">
                <div class="category-card cat-men" data-aos="fade-up" data-aos-delay="300">
                  <div class="category-image">
                    <img src="assets/img/category/shopping.jpg" alt="Category 2" class="img-fluid">
                  </div>
                  <div class="category-content">
                    <h4>Shopping</h4>
                    <a href="category.html?category=Shopping" class="card-link">View Now <i class="bi bi-arrow-right"></i></a>
                  </div>
                </div>
              </div>

              <div class="col-xl-6">
                <div class="category-card cat-kids" data-aos="fade-up" data-aos-delay="400">
                  <div class="category-image">
                    <img src="assets/img/category/travel.jpg" alt="Category 3" class="img-fluid">
                  </div>
                  <div class="category-content">
                    <h4>Travel</h4>
                    <a href="category.html?category=Travel" class="card-link">View Now <i class="bi bi-arrow-right"></i></a>
                  </div>
                </div>
              </div>

              <div class="col-xl-6">
                <div class="category-card cat-cosmetics" data-aos="fade-up" data-aos-delay="500">
                  <div class="category-image">
                    <img src="assets/img/category/electronics.jpg" alt="Category 4" class="img-fluid">
                  </div>
                  <div class="category-content">
                    <h4>Electronics</h4>
                    <a href="category.html?category=Electronics" class="card-link">View Now <i class="bi bi-arrow-right"></i></a>
                  </div>
                </div>
              </div>

              <div class="col-xl-6">
                <div class="category-card cat-accessories" data-aos="fade-up" data-aos-delay="600">
                  <div class="category-image">
                    <img src="assets/img/category/health_beauty.jpg" alt="Category 5" class="img-fluid">
                  </div>
                  <div class="category-content">
                    <h4>Health & Beauty</h4>
                    <a href="category.html?category=Health" class="card-link">View Now <i class="bi bi-arrow-right"></i></a>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>

      </div>
    </section><!-- /Promo Cards Section -->

  </main>

  </br>
  </br>

  <footer id="footer" class="footer dark-background">
    <div class="footer-main">
      <div class="container">
        <div class="row gy-4">
          <div class="col-lg-6 col-md-6">
            <div class="footer-widget footer-about">
              <a href="index.html" class="logo">
                <span class="sitename">Optima Bank Rewards</span>
              </a>
              <p>Your trusted partner in redeeming exclusive vouchers and managing your loyalty points with ease.</p>

              <div class="social-links mt-4">
                <h5>Connect With Us</h5>
                <div class="social-icons">
                  <a href="#" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
                  <a href="#" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
                  <a href="#" aria-label="Twitter"><i class="bi bi-twitter-x"></i></a>
                  <a href="#" aria-label="TikTok"><i class="bi bi-tiktok"></i></a>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6 col-md-6">
            <div class="footer-widget">
              <h4>Contact Information</h4>
              <div class="footer-contact">
                <div class="contact-item">
                  <i class="bi bi-geo-alt"></i>
                  <span>Main branch - No 23, Jalan Melati 3, Bandar Melati, 75450 Alor Gajah, Melaka</span>
                </div>
                <div class="contact-item">
                  <i class="bi bi-telephone"></i>
                  <span>+60 12-345 6789</span>
                </div>
                <div class="contact-item">
                  <i class="bi bi-envelope"></i>
                  <span>info@optimabank.com</span>
                </div>
                <div class="contact-item">
                  <i class="bi bi-clock"></i>
                  <span>Monday-Friday: 9am - 6pm<br>Saturday & Sunday: 10am - 3.30pm</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="container">
        <div class="row gy-3 align-items-center">
          <div class="col-lg-6 col-md-12">
            <div class="copyright">
              <p>© <span>Copyright</span> <strong class="sitename">Optima Bank</strong>. All Rights Reserved.</p>
            </div>
            <div class="credits mt-1">
              <!-- All the links in the footer should remain intact. -->
              <!-- You can delete the links only if you've purchased the pro version. -->
              <!-- Licensing information: https://bootstrapmade.com/license/ -->
              <!-- Purchase the pro version with working PHP/AJAX contact form: [buy-url] -->
              Designed by The Glory - GIFT UTeM
            </div>
          </div>

          <div class="col-lg-6 col-md-12">
            <div class="d-flex flex-wrap justify-content-lg-end justify-content-center align-items-center gap-4">
              <div class="payment-methods">
                <div class="payment-icons">
                  <i class="bi bi-credit-card" aria-label="Credit Card"></i>
                  <i class="bi bi-paypal" aria-label="PayPal"></i>
                  <i class="bi bi-apple" aria-label="Apple Pay"></i>
                  <i class="bi bi-google" aria-label="Google Pay"></i>
                  <i class="bi bi-cash" aria-label="Cash on Delivery"></i>
                </div>
              </div>

              <!-- <div class="legal-links">
                <a href="tos.html">Terms</a>
                <a href="privacy.html">Privacy</a>
                <a href="tos.html">Cookies</a>
              </div> -->
            </div>
          </div>
        </div>

      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/drift-zoom/Drift.min.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

  <!-- Firebase Initialization and Auth State Management -->
  <script type="module">

  // 🔹 Reusable Toast Function
  function showToast(message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `custom-toast ${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } 
    from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import firebaseConfig from "./config.js";   // ✅ import the config

  // 🔹 Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const authButtons = document.getElementById("authButtons");
  const accountBtn = document.getElementById("accountBtn");

  // 🔹 Listen for login state changes
// 🔹 Check Firebase Auth first
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // Firebase user
    fetch("http://localhost/TheGlory/getUser.php?uid=" + user.uid)
      .then((res) => res.json())
      .then((dbUser) => {
        let photoURL = dbUser.profile_image || "assets/img/default-avatar.png";
        accountBtn.innerHTML = `
          <img src="${photoURL}" 
               alt="User Avatar" 
               class="rounded-circle" 
               style="width:32px; height:32px; object-fit:cover;">
        `;
      });

    document.querySelector(".dropdown-header h6").textContent =
      `Welcome ${user.displayName}`;

    authButtons.innerHTML = `
      <button id="logoutBtn" class="btn btn-danger w-100">Logout</button>
    `;

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        sessionStorage.removeItem("user"); // clear normal session too
        sessionStorage.removeItem("cartCount"); // clear cart count
        setTimeout(() => location.reload(), 1500);
        showToast("Logged out successfully", "success");
      } catch (err) {
        showToast("Logout failed: " + err.message, "error");
      }
    });

    const userResponse = await fetch("http://localhost/TheGlory/getUser.php?uid=" + user.uid);

    const userData = await userResponse.json();
    // if PHP returns array, take first element
    let userObj = Array.isArray(userData) ? userData[0] : userData;
    // Save session in browser
    sessionStorage.setItem("user", JSON.stringify({
      id: userObj.id,
      username: userObj.username,
      email: userObj.email,
      phone: userObj.phone_number,
      points: userObj.points
    }));

    const cartResponse = await fetch("http://localhost/TheGlory/getCart.php?user_id=" + userObj.id);
    const cartData = await cartResponse.json();
    // Use "totalItems" from PHP response instead of length
    const cartCount = cartData.totalItems || 0;
    document.querySelector(".header-action-btn .badge").textContent = cartCount;  
    // save cart count to sessionStorage
    sessionStorage.setItem("cartCount", cartCount);    
    const PointsElement = document.getElementsByClassName("header-nav-points");
    if(userObj.points !== undefined){
      document.getElementById("currentPoints").textContent = userObj.points;
      PointsElement[0].style.display = "block"; // show points section
    } else {
      PointsElement[0].style.display = "none"; // hide points section
    }
  } else {
    // 🔹 If not Firebase, check normal login session
    const localUser = JSON.parse(sessionStorage.getItem("user"));
    if (localUser) {
      // Normal user UI update
      accountBtn.innerHTML = `
        <img src="assets/img/default-avatar.png"
             alt="User Avatar"
             class="rounded-circle"
             style="width:32px; height:32px; object-fit:cover;">
      `;

      document.querySelector(".dropdown-header h6").textContent =
        `Welcome ${localUser.username}`;

      authButtons.innerHTML = `
        <button id="logoutBtn" class="btn btn-danger w-100">Logout</button>
      `;

      document.getElementById("logoutBtn").addEventListener("click", () => {
        sessionStorage.removeItem("user");
        setTimeout(() => location.reload(), 1500);
        showToast("Logged out successfully", "success");
      });

      const cartResponse = await fetch("http://localhost/TheGlory/getCart.php?user_id=" + localUser.id);
        const cartData = await cartResponse.json();
        // Use "totalItems" from PHP response instead of length
        const cartCount = cartData.totalItems || 0;
      document.querySelector(".header-action-btn .badge").textContent = cartCount;  
      // save cart count to sessionStorage
      sessionStorage.setItem("cartCount", cartCount);  
      const PointsElement = document.getElementsByClassName("header-nav-points");
      if(localUser.points !== undefined){
        document.getElementById("currentPoints").textContent = localUser.points;
        PointsElement[0].style.display = "block"; // show points section
      } else {
        PointsElement[0].style.display = "none"; // hide points section
      }

    } else {
      // Guest
      document.querySelector(".dropdown-header h6").textContent =
        `Welcome to Optima Bank`;

      authButtons.innerHTML = `
        <a href="login.html" class="btn btn-primary w-100 mb-2">Sign In</a>
        <a href="register.html" class="btn btn-outline-primary w-100">Register</a>
      `;
    }
  }
});
</script>
<script>
// 🔹 Reusable toast function
function showToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;

  // Add to DOM
  document.body.appendChild(toast);

  // Remove after animation (3s)
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

</script>

<script>
async function loadVouchers(limit = null) {
  try {
    let url = "http://localhost/TheGlory/getVoucher.php";
    if (limit !== null) {
      url += `?limit=${limit}`;
    }

    const res = await fetch(url);
    const result = await res.json();

    const vouchers = result.data || [];   // extract data
    const total = result.total || 0;      // extract total

    const container = document.getElementById("voucher-list");
    container.innerHTML = ""; // Clear previous content

    vouchers.forEach(v => {
      container.innerHTML += `
        <div class="col-lg-3 col-md-6">
          <div class="product-item">
            <div class="product-image">
              <img src="${v.image}" alt="Voucher Image ${v.id}" class="img-fluid" loading="lazy">
              <button class="cart-btn" data-id="${v.id}">Add to Cart</button>
            </div>
            <div class="product-info">
              <div class="product-category">${v.category}</div>
              <h4 class="product-name" style="font-weight:600;color:black;font-size:larger;line-height:1.3;margin-bottom:8px;">
                <a href="voucher-details.html?id=${v.id}">${v.title}</a>
              </h4>
              <div class="product-name"><p>${v.description}</p></div>
              <div class="product-price"><span class="current-price">${v.points} Points</span></div>
              <div class="btm-btns row g-2">
                <div class="col-6">
                  <a href="voucher-details.html?id=${v.id}" class="btn btn-outline-custom w-100">View Details</a>
                </div>
                <div class="col-6">
                  <a href="#" class="btn btn-custom w-100 btn-redeem" data-id="${v.id}" data-title="${v.title}" data-points="${v.points}" data-action="redeem">Redeem Now</a>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    });

    container.innerHTML += `
      <div class="text-center mt-4">
        <button id="load-more-btn" class="btn btn-outline-custom" style="outline-color:black; color:black;">
          View More Vouchers
        </button>
      </div>`;
  } catch (err) {
    console.error("Error loading vouchers:", err);
  }
}

loadVouchers(4); // load only 4 vouchers
// loadVouchers(); // load all vouchers
</script>

<script>
document.addEventListener("click", function(event) {
  if (event.target && event.target.id === "load-more-btn") {
    window.location.href = "category.html";
  }
});
</script>

<script>
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `custom-toast ${type}`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }


  // Point-based categorization for homepage vouchers
  let homeUserPoints = 0;

  async function getHomeUserPoints() {
    try {
      const localUser = JSON.parse(sessionStorage.getItem("user"));
      if (!localUser || !localUser.id) {
        return 0;
      }

      const response = await fetch(`http://localhost/TheGlory/getUserPoints.php?user_id=${localUser.id}`);
      const data = await response.json();
      
      if (data.error) {
        console.error('Error fetching user points:', data.error);
        return 0;
      }
      
      return data.points || 0;
    } catch (error) {
      console.error('Error fetching user points:', error);
      return 0;
    }
  }

  function categorizeHomeVouchers() {
    const voucherItems = document.querySelectorAll('#voucher-list .product-item');
    
    voucherItems.forEach(item => {
      const pointsElement = item.querySelector('.current-price');
      if (!pointsElement) return;
      
      const requiredPoints = parseInt(pointsElement.textContent.match(/\d+/)[0]);
      const redeemBtn = item.querySelector('.btn-custom');
      
      // Remove existing classes
      item.classList.remove('affordable', 'unaffordable');
      if (redeemBtn) {
        redeemBtn.classList.remove('affordable', 'unaffordable');
      }
      
      // Remove existing points indicator
      const existingIndicator = item.querySelector('.points-indicator');
      if (existingIndicator) {
        existingIndicator.remove();
      }
      
      // Remove existing insufficient points text
      const existingText = item.querySelector('.insufficient-points-text');
      if (existingText) {
        existingText.remove();
      }
      
      // Only categorize if user has points (is logged in)
      if (homeUserPoints > 0) {
        // Create points indicator
        const pointsIndicator = document.createElement('div');
        pointsIndicator.className = 'points-indicator';
        
        // Make product image container relative
        const productImage = item.querySelector('.product-image');
        if (productImage) {
          productImage.style.position = 'relative';
        }
        
        if (homeUserPoints >= requiredPoints) {
          // User can afford this voucher - Green styling
          item.classList.add('affordable');
          
          if (redeemBtn) {
            redeemBtn.classList.add('affordable');
            redeemBtn.disabled = false;
          }
          
          pointsIndicator.classList.add('sufficient');
          pointsIndicator.textContent = '✓ Available';
          
        } else {
          // User cannot afford this voucher - Red styling
          item.classList.add('unaffordable');
          
          if (redeemBtn) {
            redeemBtn.classList.add('unaffordable');
            redeemBtn.disabled = true;
          }
          
          pointsIndicator.classList.add('insufficient');
          pointsIndicator.textContent = '✗ Need More';
          
          // Add insufficient points text
          const insufficientText = document.createElement('div');
          insufficientText.className = 'insufficient-points-text';
          insufficientText.textContent = `Need ${requiredPoints - homeUserPoints} more points`;
          const productInfo = item.querySelector('.product-info');
          if (productInfo) {
            productInfo.appendChild(insufficientText);
          }
        }
        
        if (productImage) {
          productImage.appendChild(pointsIndicator);
        }
      }
    });
  }

  // Initialize home page voucher categorization
  async function initializeHomeVouchers() {
    homeUserPoints = await getHomeUserPoints();
    
    // Wait for vouchers to load, then categorize
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
          // Check if voucher items were added
          const hasVouchers = document.querySelector('#voucher-list .product-item');
          if (hasVouchers) {
            setTimeout(() => {
              categorizeHomeVouchers();
            }, 200);
            observer.disconnect();
          }
        }
      });
    });

    // Start observing
    const voucherList = document.getElementById('voucher-list');
    if (voucherList) {
      observer.observe(voucherList, { childList: true, subtree: true });
      
      // Also check immediately in case vouchers are already loaded
      setTimeout(() => {
        const hasVouchers = document.querySelector('#voucher-list .product-item');
        if (hasVouchers) {
          categorizeHomeVouchers();
        }
      }, 1000);
      
      // Additional check after a longer delay to ensure vouchers are loaded
      setTimeout(() => {
        categorizeHomeVouchers();
      }, 2000);
    }
  }

// Override the existing add to cart functionality for home page
document.addEventListener("click", function (event) {
  if (event.target && event.target.classList.contains("cart-btn") && document.querySelector('#voucher-list')) {
    // This is for homepage vouchers
    const voucherId = event.target.getAttribute("data-id");
    const quantity = 1;

    if (!voucherId || quantity < 1) {
      alert("Invalid voucher or quantity.");
      return;
    }

    const localUser = JSON.parse(sessionStorage.getItem("user"));
    const userId = localUser ? localUser.id : 0;

    fetch("http://localhost/TheGlory/addToCart.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ voucher_id: voucherId, user_id: userId, quantity: quantity })
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === "success") {
          sessionStorage.setItem("cartCount", data.totalItems);
          document.querySelector(".badge").textContent = data.totalItems;
          showToast("Voucher added to cart!", "success");
        } else {
          showToast("Failed to add voucher to cart: " + data.message, "error");
        }
      })
      .catch(error => {
        console.error("Error adding to cart:", error);
        showToast("An error occurred while adding to cart.", "error");
      });
  }
});

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeHomeVouchers);
} else {
  initializeHomeVouchers();
}

// Also initialize when user authentication state changes
document.addEventListener('userLoggedIn', initializeHomeVouchers);
</script>

<script>

function generateVoucherCode(length = 8) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < length; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

document.addEventListener("click", function(event) {
  if (event.target && event.target.classList.contains("btn-redeem")) {
    event.preventDefault();

    const voucherId = event.target.getAttribute("data-id");
    const voucherTitle = event.target.getAttribute("data-title");
    const voucherPoints = parseInt(event.target.getAttribute("data-points"), 10);

    const localUser = JSON.parse(sessionStorage.getItem("user"));
    if (!localUser) {
      showToast("Please log in to redeem vouchers.", "error");
      return;
    }

    const userPoints = localUser.points || 0;

    document.getElementById("userPoints").textContent = userPoints;
    document.getElementById("voucherTitle").textContent = voucherTitle; 
    document.getElementById("voucherPoints").textContent = voucherPoints;
    document.getElementById("confirmRedeemBtn").setAttribute("data-id", voucherId);
    document.getElementById("confirmRedeemBtn").setAttribute("data-points", voucherPoints);
    const redeemModal = new bootstrap.Modal(document.getElementById("redeemModal"));
    redeemModal.show();
  }

    const confirmBtn = document.getElementById("confirmRedeemBtn");

    // Clear previous handlers
    confirmBtn.replaceWith(confirmBtn.cloneNode(true));

    // Re-select the button (the old one was replaced)
    const newConfirmBtn = document.getElementById("confirmRedeemBtn");

    newConfirmBtn.addEventListener("click", async function() {

      const localUser = JSON.parse(sessionStorage.getItem("user"));
      if (!localUser) {
        showToast("Please log in to redeem vouchers.", "error");
        return;
      }
      // Collect selected items
      const selectedItems = [];
      selectedItems.push({
          voucher_id: this.getAttribute("data-id"),
          quantity:  1,
          code: generateVoucherCode(10)
      });

      if (selectedItems.length === 0) {
        showToast("Please select at least one item.", "error");
        return;
      }

      // No enough points cannot redeem
      const userPoints = localUser.points || 0;  
      const voucherPoints = parseInt(this.getAttribute("data-points"), 10);
      if (userPoints < voucherPoints) {
        showToast("Not enough points to redeem this voucher.", "error");
        return;
      }

      try {
      const res = await fetch("http://localhost/TheGlory/redeem.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: localUser.id,
          items: selectedItems
        })
      });

      const data = await res.json();
      if (data.status === "success") {
        showToast("Redemption successful! Use Voucher Code to redeem your rewards", "success");
        localUser.points -= data.points_deducted;
        sessionStorage.setItem("user", JSON.stringify(localUser));
        setTimeout(() => { window.location.href = "account.html#orders"; }, 2000);
      } else {
        showToast("Redemption failed: " + data.message, "error");
      }
    } catch (err) {
      console.error(err);
      showToast("Error redeeming vouchers", "error");
    }
  });
});
</script>

</body>

</html>